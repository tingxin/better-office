<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠå…¬å®¤ç”Ÿå­˜æ¸¸æˆ - æ’ä»¶è¯„åˆ†</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .plugins-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .plugin-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .plugin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .plugin-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .plugin-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 15px;
            color: white;
        }

        .plugin-info h3 {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 5px;
        }

        .plugin-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: #666;
        }

        .plugin-description {
            color: #555;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .plugin-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .rating-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stars-display {
            display: flex;
            gap: 2px;
        }

        .star-display {
            color: #ffc107;
            font-size: 1.2rem;
        }

        .star-display.empty {
            color: #ddd;
        }

        .rating-text {
            font-weight: 600;
            color: #333;
        }

        .rating-count {
            color: #666;
            font-size: 0.9rem;
        }

        .rating-section {
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .rating-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .stars-rating {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 15px;
        }

        .star {
            font-size: 2rem;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .star:hover,
        .star.active {
            color: #ffc107;
            transform: scale(1.1);
        }

        .star.hover {
            color: #ffeb3b;
        }

        .comment-section {
            margin-top: 15px;
        }

        .comment-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 15px;
        }

        .comment-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: #666;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .plugins-grid {
                grid-template-columns: 1fr;
            }

            .plugin-stats {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® åŠå…¬å®¤ç”Ÿå­˜æ¸¸æˆæ’ä»¶</h1>
            <p>ä¸ºä½ å–œæ¬¢çš„æ’ä»¶è¯„åˆ†ï¼Œå¸®åŠ©æ”¹å–„åŠå…¬å®¤ç¯å¢ƒï¼</p>
        </div>

        <div id="loading" class="loading">
            æ­£åœ¨åŠ è½½æ’ä»¶ä¿¡æ¯...
        </div>

        <div id="plugins-container" class="plugins-grid" style="display: none;">
            <!-- æ’ä»¶å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="footer">
            <p>æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼æ‚¨çš„è¯„åˆ†å°†å¸®åŠ©æˆ‘ä»¬æ”¹è¿›æ’ä»¶è´¨é‡ã€‚</p>
        </div>
    </div>

    <script>
        // å›¾æ ‡æ˜ å°„
        const iconMap = {
            'snowflake': 'â„ï¸',
            'printer': 'ğŸ–¨ï¸',
            'lightbulb': 'ğŸ’¡',
            'broom': 'ğŸ§¹',
            'network': 'ğŸŒ',
            'plugin': 'ğŸ”Œ'
        };

        // å½“å‰ç”¨æˆ·è¯„åˆ†çŠ¶æ€
        let userRatings = {};

        // é¡µé¢åŠ è½½å®Œæˆåè·å–æ’ä»¶æ•°æ®
        document.addEventListener('DOMContentLoaded', function () {
            loadPlugins();
        });

        // åŠ è½½æ’ä»¶æ•°æ®
        async function loadPlugins() {
            try {
                const response = await fetch('/api/plugins');
                const data = await response.json();

                if (data.success) {
                    renderPlugins(data.plugins);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('plugins-container').style.display = 'grid';
                } else {
                    showError('åŠ è½½æ’ä»¶å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                console.error('åŠ è½½æ’ä»¶å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // æ¸²æŸ“æ’ä»¶åˆ—è¡¨
        function renderPlugins(plugins) {
            const container = document.getElementById('plugins-container');
            container.innerHTML = '';

            plugins.forEach(plugin => {
                const pluginCard = createPluginCard(plugin);
                container.appendChild(pluginCard);
            });
        }

        // åˆ›å»ºæ’ä»¶å¡ç‰‡
        function createPluginCard(plugin) {
            const card = document.createElement('div');
            card.className = 'plugin-card';
            card.style.borderColor = plugin.color + '20';

            const icon = iconMap[plugin.icon] || iconMap['plugin'];
            const averageRating = parseFloat(plugin.average_rating) || 0;
            const totalRatings = parseInt(plugin.total_ratings) || 0;

            card.innerHTML = `
                <div class="plugin-header">
                    <div class="plugin-icon" style="background: ${plugin.color}">
                        ${icon}
                    </div>
                    <div class="plugin-info">
                        <h3>${plugin.plugin_name}</h3>
                        <div class="plugin-meta">
                            <span>ğŸ‘¤ ${plugin.author}</span>
                            <span>ğŸ“¦ v${plugin.version}</span>
                            <span>ğŸ·ï¸ ${plugin.category}</span>
                        </div>
                    </div>
                </div>
                
                <div class="plugin-description">
                    ${plugin.description}
                </div>
                
                <div class="plugin-stats">
                    <div class="rating-display">
                        <div class="stars-display">
                            ${generateStarsDisplay(averageRating)}
                        </div>
                        <span class="rating-text">${averageRating.toFixed(1)}</span>
                    </div>
                    <div class="rating-count">
                        ${totalRatings} ä¸ªè¯„åˆ†
                    </div>
                </div>
                
                <div class="rating-section">
                    <div class="rating-title">ä¸ºè¿™ä¸ªæ’ä»¶è¯„åˆ†</div>
                    <div class="stars-rating" data-plugin-id="${plugin.id}">
                        ${generateRatingStars(plugin.id)}
                    </div>
                    <div class="comment-section">
                        <textarea 
                            class="comment-input" 
                            placeholder="åˆ†äº«æ‚¨çš„ä½¿ç”¨ä½“éªŒï¼ˆå¯é€‰ï¼‰..."
                            id="comment-${plugin.id}"
                        ></textarea>
                        <button 
                            class="submit-btn" 
                            onclick="submitRating(${plugin.id})"
                            id="submit-${plugin.id}"
                        >
                            æäº¤è¯„åˆ†
                        </button>
                    </div>
                    <div id="message-${plugin.id}"></div>
                </div>
            `;

            return card;
        }

        // ç”Ÿæˆæ˜¾ç¤ºç”¨çš„æ˜Ÿæ˜Ÿ
        function generateStarsDisplay(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<span class="star-display">â˜…</span>';
                } else if (i - 0.5 <= rating) {
                    stars += '<span class="star-display">â˜†</span>';
                } else {
                    stars += '<span class="star-display empty">â˜†</span>';
                }
            }
            return stars;
        }

        // ç”Ÿæˆè¯„åˆ†ç”¨çš„æ˜Ÿæ˜Ÿ
        function generateRatingStars(pluginId) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<span class="star" data-rating="${i}" onclick="setRating(${pluginId}, ${i})" onmouseover="hoverRating(${pluginId}, ${i})" onmouseout="unhoverRating(${pluginId})">â˜†</span>`;
            }
            return stars;
        }

        // è®¾ç½®è¯„åˆ†
        function setRating(pluginId, rating) {
            userRatings[pluginId] = rating;
            updateStarsDisplay(pluginId, rating);
        }

        // é¼ æ ‡æ‚¬åœæ•ˆæœ
        function hoverRating(pluginId, rating) {
            const stars = document.querySelectorAll(`[data-plugin-id="${pluginId}"] .star`);
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('hover');
                } else {
                    star.classList.remove('hover');
                }
            });
        }

        // å–æ¶ˆæ‚¬åœæ•ˆæœ
        function unhoverRating(pluginId) {
            const stars = document.querySelectorAll(`[data-plugin-id="${pluginId}"] .star`);
            stars.forEach(star => {
                star.classList.remove('hover');
            });

            // æ¢å¤å½“å‰è¯„åˆ†æ˜¾ç¤º
            if (userRatings[pluginId]) {
                updateStarsDisplay(pluginId, userRatings[pluginId]);
            }
        }

        // æ›´æ–°æ˜Ÿæ˜Ÿæ˜¾ç¤º
        function updateStarsDisplay(pluginId, rating) {
            const stars = document.querySelectorAll(`[data-plugin-id="${pluginId}"] .star`);
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                    star.textContent = 'â˜…';
                } else {
                    star.classList.remove('active');
                    star.textContent = 'â˜†';
                }
            });
        }

        // æäº¤è¯„åˆ†
        async function submitRating(pluginId) {
            const rating = userRatings[pluginId];
            if (!rating) {
                showMessage(pluginId, 'è¯·å…ˆé€‰æ‹©è¯„åˆ†', 'error');
                return;
            }

            const comment = document.getElementById(`comment-${pluginId}`).value.trim();
            const submitBtn = document.getElementById(`submit-${pluginId}`);

            // ç¦ç”¨æäº¤æŒ‰é’®
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';

            try {
                const response = await fetch('/api/rate-plugin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        plugin_id: pluginId,
                        rating: rating,
                        comment: comment
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showMessage(pluginId, 'è¯„åˆ†æäº¤æˆåŠŸï¼æ„Ÿè°¢æ‚¨çš„å‚ä¸ã€‚', 'success');
                    // ç¦ç”¨è¯„åˆ†åŒºåŸŸ
                    disableRatingSection(pluginId);
                    // é‡æ–°åŠ è½½æ’ä»¶æ•°æ®ä»¥æ›´æ–°ç»Ÿè®¡
                    setTimeout(() => {
                        loadPlugins();
                    }, 2000);
                } else {
                    showMessage(pluginId, 'æäº¤å¤±è´¥: ' + data.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'æäº¤è¯„åˆ†';
                }
            } catch (error) {
                console.error('æäº¤è¯„åˆ†å¤±è´¥:', error);
                showMessage(pluginId, 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'æäº¤è¯„åˆ†';
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(pluginId, message, type) {
            const messageDiv = document.getElementById(`message-${pluginId}`);
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;

            // 3ç§’åè‡ªåŠ¨æ¸…é™¤æ¶ˆæ¯
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const loading = document.getElementById('loading');
            loading.innerHTML = `<div class="message error">${message}</div>`;
        }

        // ç¦ç”¨è¯„åˆ†åŒºåŸŸ
        function disableRatingSection(pluginId) {
            const stars = document.querySelectorAll(`[data-plugin-id="${pluginId}"] .star`);
            const comment = document.getElementById(`comment-${pluginId}`);
            const submitBtn = document.getElementById(`submit-${pluginId}`);

            stars.forEach(star => {
                star.style.cursor = 'not-allowed';
                star.onclick = null;
                star.onmouseover = null;
                star.onmouseout = null;
            });

            comment.disabled = true;
            submitBtn.disabled = true;
            submitBtn.textContent = 'å·²æäº¤';
        }
    </script>
</body>

</html>